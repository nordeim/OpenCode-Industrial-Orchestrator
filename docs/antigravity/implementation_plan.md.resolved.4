# Session Entity Test Fixes - Implementation Plan

## Issue Categories

### Category 1: SessionStatus `cls` NameError (HIGH PRIORITY)
**Affects:** ~15 tests (all state transition tests)
**Root Cause:** Line 131 of [session_status.py](file:///home/project/opencode-industrial-orchestrator/orchestrator/src/industrial_orchestrator/domain/value_objects/session_status.py) uses `cls` in a dict comprehension inside an instance method, but `cls` is only available in `@classmethod` methods.

```python
# Current (broken)
**{state: set() for state in cls.get_terminal_states()},  # NameError

# Fix
**{state: set() for state in SessionStatus.get_terminal_states()},
```

**File:** [src/industrial_orchestrator/domain/value_objects/session_status.py](file:///home/project/opencode-industrial-orchestrator/orchestrator/src/industrial_orchestrator/domain/value_objects/session_status.py)

---

### Category 2: Test Assertion Mismatches (MEDIUM PRIORITY)
**Affects:** 2 tests
**Root Cause:** Tests expect `ValueError` with "generic" regex, but Pydantic V2 raises [ValidationError](file:///home/project/opencode-industrial-orchestrator/orchestrator/src/industrial_orchestrator/domain/exceptions/context_exceptions.py#231-254)

**File:** [tests/unit/domain/test_session_entity.py](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py)
**Fix:** Update test to catch both or match actual error message

---

### Category 3: Factory/Test Issues (MEDIUM PRIORITY)
**Remaining tests:** ~5 tests
- [test_default_agent_config_when_empty](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py#105-113)
- [test_checkpoint_rotation](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py#250-262)
- [test_create_session_with_dependencies](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py#424-431)
- [test_concurrent_state_transitions](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py#479-498)
- [test_metrics_integration](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py#499-518)

**Approach:** Fix individually after Category 1 is resolved

---

## Execution Order

1. [ ] Fix `cls` â†’ [SessionStatus](file:///home/project/opencode-industrial-orchestrator/dashboard/src/lib/api/types.ts#11-19) in session_status.py (line 131)
2. [ ] Run tests to verify transition tests now pass
3. [ ] Fix test assertions in test_invalid_titles_rejected
4. [ ] Address remaining factory/test-specific issues
5. [ ] Final verification run

---

## Files to Modify

| File | Change |
|------|--------|
| [session_status.py](file:///home/project/opencode-industrial-orchestrator/orchestrator/src/industrial_orchestrator/domain/value_objects/session_status.py) | Replace `cls` with [SessionStatus](file:///home/project/opencode-industrial-orchestrator/dashboard/src/lib/api/types.ts#11-19) |
| [test_session_entity.py](file:///home/project/opencode-industrial-orchestrator/orchestrator/tests/unit/domain/test_session_entity.py) | Update exception matching |
